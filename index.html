<!DOCTYPE html>
<html>
  <head>
    <title>This is the title of the webpage!</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div class="container">
      <div class="header">
        <button onclick="gameStart()">Select Size</button>
        <select id="select">
          <option value="5">5X5</option>
          <option value="7">7X7</option>
          <option value="10">10X10</option>
        </select>
      </div>
      <div class="game_area" id="game_area"></div>
    </div>
    <script>
      const EMPTY_CELL = 0;
      const WOLF = 1;
      const FENCE = 2;
      const HOUSE = 3;
      const RABBIT = 4;

      const gallery = new Array();

      gallery[1] = "images/gamewolf.png";
      gallery[2] = "images/ban.png";
      gallery[3] = "images/home.png";
      gallery[4] = "images/rabbit.png";

      function gameStart() {
        const gameAreaSize = parseInt(document.getElementById("select").value);
        const matrix = createGameArray(gameAreaSize);
        console.log(matrix);

        insertAllCharacters(matrix, gameAreaSize);

        eventListenersForRabbit(matrix);
      }

      function eventListenersForRabbit(array) {
        window.onkeydown = (event) => {
          if (event.key === "ArrowUp") {
            
            moveRabbitUp(array);
            changeWolvesPositions(array);

            console.log(array);
          }
          if (event.key === "ArrowDown") {
            
            moveRabbitDown(array);
            changeWolvesPositions(array);
            
            console.log(array);
          }
          if (event.key === "ArrowLeft") {
            
            moveRabbitLeft(array);
            changeWolvesPositions(array);
            console.log(array);
          }
          if (event.key === "ArrowRight") {
            
            moveRabbitRight(array);
            changeWolvesPositions(array);
            console.log(array);
          }
        };
      }

      function changeWolvesPositions(array) {
        const rabbitCords = findCharacterCords(array, RABBIT);
        const wolvesCords = findCharacterCords(array, WOLF);
        wolvesCords.forEach((item) => {
          const freeCells = findEmptyCellsArroundWolf(array, item);
          calculateDistanceFromRabbitandPlace(array, freeCells, rabbitCords, item);
        });
      }

      function findEmptyCellsArroundWolf(array, wolvesCords) {
        const [x, y] = wolvesCords;
        if (x === array.length - 1) {
          return conditionForXMax(array, wolvesCords);
        }
        if (x === 0) {
          return conditionForXMin(array, wolvesCords);
        }
        if (y === 0) {
          return conditionForYMin(array, wolvesCords);
        }
        if (y === array.length - 1) {
          return conditionForYMax(array, wolvesCords);
        } else {
          return conditionForAll(array, wolvesCords);
        }
      }

      function conditionForAll(array, wolvesCords) {
        const [x, y] = wolvesCords;
        const cordsArray = [];
        if(array[x - 1][y] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x - 1][y] === EMPTY_CELL) {
          cordsArray.push([x - 1, y]);
        }

        if(array[x + 1][y] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x + 1][y] === EMPTY_CELL) {
          cordsArray.push([x + 1, y]);
        }

        if(array[x][y - 1] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x][y - 1] === EMPTY_CELL) {
          cordsArray.push([x, y - 1]);
        }

        if(array[x][y + 1] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x][y + 1] === EMPTY_CELL) {
          cordsArray.push([x, y + 1]);
        }
        
        return cordsArray;
      }

      function conditionForXMax(array, wolvesCords) {
        const [x, y] = wolvesCords;
        const cordsArray = [];

        if( array[x - 1][y] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x - 1][y] === EMPTY_CELL) {
          cordsArray.push([x - 1, y]);
        }

        if( array[x][y - 1] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x][y - 1] === EMPTY_CELL) {
          cordsArray.push([x, y - 1]);
        }

        if( array[x][y + 1] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x][y + 1] === EMPTY_CELL) {
          cordsArray.push([x, y + 1]);
        }
        
        return cordsArray;
      }

      function conditionForXMin(array, wolvesCords) {
        const [x, y] = wolvesCords;
        const cordsArray = [];

        if( array[x + 1][y] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x + 1][y] === EMPTY_CELL) {
          cordsArray.push([x + 1, y]);
        }

        if( array[x][y - 1] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x][y - 1] === EMPTY_CELL) {
          cordsArray.push([x, y - 1]);
        }

        if( array[x][y + 1] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x][y + 1] === EMPTY_CELL) {
          cordsArray.push([x, y + 1]);
        }
        
        return cordsArray;
      }

      function conditionForYMin(array, wolvesCords) {
        const [x, y] = wolvesCords;
        const cordsArray = [];


        if( array[x - 1][y] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x - 1][y] === EMPTY_CELL) {
          cordsArray.push([x - 1, y]);
        }


        if( array[x + 1][y] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x + 1][y] === EMPTY_CELL) {
          cordsArray.push([x + 1, y]);
        }


        if( array[x][y + 1] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x][y + 1] === EMPTY_CELL) {
          cordsArray.push([x, y + 1]);
        }
        
        return cordsArray;
      }

      function conditionForYMax(array, wolvesCords) {
        const [x, y] = wolvesCords;
        const cordsArray = [];


        if( array[x - 1][y] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x - 1][y] === EMPTY_CELL) {
          cordsArray.push([x - 1, y]);
        }


        if( array[x + 1][y] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x + 1][y] === EMPTY_CELL) {
          cordsArray.push([x + 1, y]);
        }


        if( array[x][y - 1] === RABBIT && array[x - 1][y] != HOUSE){
          alert("Game over")
          return
        } else
        if (array[x][y - 1] === EMPTY_CELL) {
          cordsArray.push([x, y - 1]);
        }
        
        return cordsArray;
      }

      function calculateDistanceFromRabbitandPlace(array, freeVellsArray, rabbitCords, item) {

        const distanceArray = []
        freeVellsArray.forEach((item) => {
          const distance = calculateDistanceFromRabbit(item, rabbitCords);
          distanceArray.push(distance)
        });
        // console.log(distanceArray)
        const max = Math.min(...distanceArray);
        const index = distanceArray.indexOf(max);
        // console.log(freeVellsArray[index])
        // console.log(freeVellsArray)
        placeWolvesIntoNewCells(array, freeVellsArray[index], item)
      }

      const equals = (a, b) => JSON.stringify(a) === JSON.stringify(b);

      function placeWolvesIntoNewCells(array, wolvesCords, item){
          const rabbitCords = findCharacterCords(array, RABBIT);
          const [x, y] = wolvesCords
          const[k, p] = item
          if(equals([x, y], rabbitCords)){
              alert("Game over")
          } else {
            array[x][y] = WOLF
            array[k][p] = EMPTY_CELL
          }
            
      }

      function calculateDistanceFromRabbit(arrayItem, rabbitCords) {
        
        let [x, y] = arrayItem;
        let [z, k] = rabbitCords[0];

        return Math.round(Math.sqrt(Math.pow(x - z, 2) + Math.pow(y - k, 2)));
      }

      function moveRabbitUp(array) {
        const rabbitCords = findCharacterCords(array, RABBIT);
        const [x, y] = rabbitCords[0];
        let newRabbitCordX = x - 1;
        if (x === 0) {
          newRabbitCordX = array.length - 1;
        }
        if (array[newRabbitCordX][y] == EMPTY_CELL) {
          array[newRabbitCordX][y] = RABBIT;
          array[x][y] = EMPTY_CELL;
        } else if (array[newRabbitCordX][y] === HOUSE) {
          alert("you win");
        } else if (array[newRabbitCordX][y] === FENCE) {
          return;
        } else if (array[newRabbitCordX][y] === WOLF) {
          alert("game over");
        }
      }
      function moveRabbitDown(array) {
        const rabbitCords = findCharacterCords(array, RABBIT);
        const [x, y] = rabbitCords[0];
        let newRabbitCordX = x + 1;
        if (x === array.length - 1) {
          newRabbitCordX = 0;
        }
        if (array[newRabbitCordX][y] === EMPTY_CELL) {
          array[newRabbitCordX][y] = RABBIT;
          array[x][y] = EMPTY_CELL;
        } else if (array[newRabbitCordX][y] === HOUSE) {
          alert("you win");
        } else if (array[newRabbitCordX][y] === FENCE) {
          return;
        } else if (array[newRabbitCordX][y] === WOLF) {
          alert("game over");
        }
      }

      function moveRabbitLeft(array) {
        const rabbitCords = findCharacterCords(array, RABBIT);
        const [x, y] = rabbitCords[0];
        let newRabbitCordY = y - 1;
        if (y === 0) {
          newRabbitCordY = array.length - 1;
        }
        if (array[x][newRabbitCordY] == EMPTY_CELL) {
          array[x][newRabbitCordY] = RABBIT;
          array[x][y] = EMPTY_CELL;
        } else if (array[x][newRabbitCordY] === HOUSE) {
          alert("you win");
        } else if (array[x][newRabbitCordY] === FENCE) {
          return;
        } else if (array[x][newRabbitCordY] === WOLF) {
          alert("game over");
        }
      }

      function moveRabbitRight(array) {
        const rabbitCords = findCharacterCords(array, RABBIT);
        const [x, y] = rabbitCords[0];
        let newRabbitCordY = y + 1;
        if (y === array.length - 1) {
          newRabbitCordY = 0;
        }
        if (array[x][newRabbitCordY] == EMPTY_CELL) {
          array[x][newRabbitCordY] = RABBIT;
          array[x][y] = EMPTY_CELL;
        } else if (array[x][newRabbitCordY] === HOUSE) {
          alert("you win");
        } else if (array[x][newRabbitCordY] === FENCE) {
          return;
        } else if (array[x][newRabbitCordY] === WOLF) {
          alert("game over");
        }
      }

      function findCharacterCords(array, character) {
        const findInMatrix = function (accumulator, row, x) {
          row.forEach((element, y) => {
            if (element === character) {
              accumulator.push([x, y]);
            }
          });

          return accumulator;
        };

        return array.reduce(findInMatrix, []);
      }

      function insertAllCharacters(array, gameAreaSize) {
        const wolvesCount = (gameAreaSize / 100) * 60;
        const fenceCount = (gameAreaSize / 100) * 40;
        insertCharactersIntoArray(array, WOLF, wolvesCount);
        insertCharactersIntoArray(array, FENCE, fenceCount);
        insertCharactersIntoArray(array, HOUSE, 1);
        insertCharactersIntoArray(array, RABBIT, 1);
      }

      function createGameArray(gameAreaSize) {
        const gameCondition = new Array(gameAreaSize)
          .fill(EMPTY_CELL)
          .map(() => new Array(gameAreaSize).fill(EMPTY_CELL));

        return gameCondition;
      }

      function insertSingleCharacter(cord, myArray, character) {
        const x = cord[0];
        const y = cord[1];
        // myArray[0,1] = cord
        myArray[x][y] = character;
      }

      function findEmptyCell(myArray) {
        const randomX = Math.floor(Math.random() * myArray.length);
        const randomY = Math.floor(Math.random() * myArray.length);
        if (myArray[randomX][randomY] === EMPTY_CELL) {
          return [randomX, randomY];
        } else {
          return findEmptyCell(myArray);
        }
      }

      function insertCharactersIntoArray(myArray, character, count) {
        for (let i = 0; i < count; i++) {
          const cords = findEmptyCell(myArray);
          insertSingleCharacter(cords, myArray, character);
        }
        return myArray;
      }
    </script>
  </body>
</html>
